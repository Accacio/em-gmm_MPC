#+TITLE: Simon
#+OPTIONS: toc:nil
#+latex_header:\definecolor{nord0}{HTML}{2E3440} \definecolor{nord1}{HTML}{3B4252} \definecolor{nord2}{HTML}{434C5E} \definecolor{nord3}{HTML}{4C566A} \definecolor{nord4}{HTML}{D8DEE9} \definecolor{nord5}{HTML}{E5E9F0} \definecolor{nord6}{HTML}{ECEFF4} \definecolor{nord7}{HTML}{8FBCBB} \definecolor{nord8}{HTML}{88C0D0} \definecolor{nord9}{HTML}{81A1C1} \definecolor{nord10}{HTML}{5E81AC} \definecolor{nord11}{HTML}{BF616A} \definecolor{nord12}{HTML}{D08770} \definecolor{nord13}{HTML}{EBCB8B} \definecolor{nord14}{HTML}{A3BE8C} \definecolor{nord15}{HTML}{B48EAD}
#+latex_header:\lstset{basicstyle=\ttfamily\color{nord4},backgroundcolor=\color{nord1},keywordstyle=\color{nord10},identifierstyle=\color{nord7},commentstyle=\color{nord3!0.2!gray},flexiblecolumns=true,stringstyle=\color{nord14},breaklines=false,linewidth=\linewidth,xleftmargin=-1cm,showstringspaces=false,keepspaces=true,showtabs=true,tabsize=2}
#+latex_header: \usepackage[style=authoryear]{biblatex}
#+latex_header: \addbibresource{~/docsThese/bibliography.bib}

* Introduction
- I'm using a simple example to illustrate (2 variables \to 4 zones)
- I show in this document examples for 2 cases :
  + Generating data for all 4 zones
  + Generating data for one specific zone


#+begin_src matlab
values={linspace(-0,5,20)}; % All zones
#+end_src

#+begin_src matlab
values={linspace(0,1,20), linspace(3,5,20),}; % 1 active
#+end_src

For the implementation I describe the two methods used:
- Annealing (used on the article)
- Estimating $\Sigma$ (as you recommended)

** Annealing
- Initialize with $\Sigma=10\cdot I$
- If affected data in a zone doesn't change between iterations reduce respective $\Sigma$ in 90%

** Estimating $\Sigma$
I adapted the formula from cite:Bishop2006
$$\boldsymbol{\Sigma}_{k}=\frac{1}{N_{k}} \sum_{n=1}^{N} \gamma\left(z_{n k}\right)\left(\mathbf{x}_{n}-\boldsymbol{\mu}_{k}\right)\left(\mathbf{x}_{n}-\boldsymbol{\mu}_{k}\right)^{\mathrm{T}}$$
with $N_k = \sum_{n=1}^N \gamma(z_{nk})$


- implementation ([[https://github.com/Accacio/em-gmm_MPC/blob/main/update_parameters.m][code]])
#+begin_src matlab
sigma_weighted=err_diag*diag(responsibilities)*err_diag.';
sigma_num=zeros(n);
for j=0:N-1
    sigma_num=sigma_num+sigma_weighted(n*j+1:n*j+1+(n-1),n*j+1:n*j+1+(n-1));
end
Sigma(:,:,i)=sigma_num/N_k(i);
#+end_src

\texttt{sigma\_weighted} is a block diagonal matrix where each block is $\gamma\left(z_{n k}\right)\left(\mathbf{x}_{n}-\boldsymbol{\mu}_{k}\right)\left(\mathbf{x}_{n}-\boldsymbol{\mu}_{k}\right)^{\mathrm{T}}$ then I slice and sum.

* Study Case
The data shown here is
- \texttt{Phi\_init} :: Value used to initialize algo
- \texttt{Phi\_init\_orig} :: Truth Value
- \texttt{Phi} :: Estimated Value
- \texttt{ans} :: $\|\Phi_{\text{init\_orig}}-\Phi\|_{F}$ (only relevant when all zones are estimated)

  (tilde) is system with cheating, i.e. multiplied by a matrix T.
** With Annealing
*** All zones
@@latex:\footnotesize@@
#+begin_example
Converged after 92 iter

Phi_init =

   1.864662813548397   0.935808813721078   0.693770142215422   2.210273054546532  -4.443376963727328  -1.885425203582169
   1.727040748875336   0.176137053955410   0.232185058403846   0.757228084261170  -3.924349620399648   0.486404223128410
   0.866493916076838   0.335465828578670   0.334276593445929   1.936606361270173   0.249996701837516  -0.747478574564384
   0.163247503416262   0.174180921713906   0.186706045729437   0.651466891007250   0.694567783127803   0.042849218958453


Phi_init_orig =

   1.470225894700000   0.235018896600000   0.235018896600000   1.241762479900000  -4.647414122572338  -2.486156232571467
   1.425745663856232                   0                   0                   0  -4.176878328479725                   0
                   0                   0                   0   1.204194183791087                   0  -1.743256693753946
                   0                   0                   0                   0                   0                   0


Phi =

   0.068484311172177  -0.042985766660654   0.032775530611746   0.980314173732669  -0.272997152419577  -1.775094691903940
   1.425477205250396   0.000678216866607   0.000566017899618   0.003501201533331  -4.179344830424456  -0.014701460883016
   1.456418739790791   0.229832396093222   0.231698713329511   1.228930976428940  -4.631040540269671  -2.475730066427419
   0.007412599830334  -0.000075092296407  -0.000733378380280   0.014894948085241  -0.032274165355937  -0.054557694405944


ans =

   6.782950334898976

Converged after 13 iter

Phi_init_tilde =

   8.068799483687913   7.402153419752725   9.506268913216010   9.534674379857902 -33.776877440657415 -38.598348397637047
   7.305971525780547   0.750660658697905   7.299276493502093   0.362799615768157 -18.399671036511574 -20.721207307231257
   0.270926600913949   6.438804276656496   0.015955655377338   7.963954367757189  -8.608222834456031  -9.743870021624694
   0.463381560735116   0.480194822643043   0.166699926912179   0.801214408968210   0.811456250404686   0.580555263711398


Phi_init_orig_tilde =

   7.901976448969828   7.348262144649572   8.871884751593567   8.809002766862379 -33.787448969354138 -38.743548949192167
   6.511227018932155                   0   7.204672105113007                   0 -19.075353842304786 -21.106877294128253
                   0   6.085113540961688                   0   7.390812152346410  -8.809139800972982 -10.699339799411552
                   0                   0                   0                   0                   0                   0


Phi_tilde =

   7.865487401412478   7.251288047577623   8.830175322807131   8.693166555522774 -33.697637484564751 -38.638079217752278
   6.485748765867495   0.025361093603623   7.176847195648638   0.030377693376640 -19.152489212842656 -21.201935408645156
   0.073886025601753   5.840793371859742   0.082816411826886   7.095186442715002  -9.024275793046391 -10.930960789866143
   0.053703293661326   0.037240802442397   0.059423154306963   0.045161342363189  -0.378176762459652  -0.433750453472707


ans =

   0.814489686504631

Elapsed time is 5.816097 seconds.
#+end_example
[[file:./20220311_1817_575x465.png]]

- comments :: I notice that even when the initial $\phi$ is closed to the truth value, each lines converges independently and do not correspond to any lines in the original. (main problem I found using the annealing approach)

*** One zone

@@latex:\footnotesize@@
#+begin_example
Converged after 2 iter

Phi_init =

   1.642750345826936   0.932076297586203   0.760215807046225   1.548510040678221  -4.045560240974508  -2.235957715600398
   1.647753276466836   0.371948112906864   0.912683607504090   0.971714764354618  -3.436104260848922   0.379942503934699
   0.989679912566058   0.331933625662668   0.473391321242503   1.787650163249551   0.310963786817605  -1.031413731286041
   0.550290497741797   0.808446512468367   0.287936122756422   0.018046956517756   0.368365043480119   0.404637677317782


Phi_init_orig =

   1.399561124000000   0.199680751200000   0.199680751200000   1.206094873500000  -4.360758434891186  -2.347243485964171
   1.366502031157586                   0                   0                   0  -3.972149418449137                   0
                   0                   0                   0   1.177605655190021                   0  -1.725077361777938
                   0                   0                   0                   0                   0                   0


Phi =

   1.366502033845666  -0.000000000266988   0.000000000920530  -0.000000000468747  -3.972149417250537  -0.000000000872632
   1.366502033845666  -0.000000000266988   0.000000000920530  -0.000000000468747  -3.972149417250537  -0.000000000872632
   1.366502033845667  -0.000000000266989   0.000000000920530  -0.000000000468747  -3.972149417250533  -0.000000000872632
   1.366502033845666  -0.000000000266989   0.000000000920530  -0.000000000468747  -3.972149417250534  -0.000000000872632


ans =

   6.844656023802376

Converged after 3 iter

Phi_init_tilde =

   3.523835609361493   4.515832886285165   5.767616294239629   3.322402182137093 -14.485625963424841 -19.766698808375939
   2.691459814955493   0.950719895284027   5.135497088541537   0.071886547874606  -5.494621214050215 -12.845965001257358
   0.638249657879700   4.834975942641918   0.123119962459020   2.713464242148269  -5.614935992338494  -3.685908223939339
   0.061999984114431   0.149609399563451   0.277209048754167   0.510629883273798   0.115807604564264   0.663743909291804


Phi_init_orig_tilde =

   2.778392929396815   4.482099875046081   5.282437831318370   3.269919770847281 -14.642074146147603 -20.145108719964895
   2.036337648616594                   0   4.741070770938011                   0  -5.919228235516395 -13.781349076850274
                   0   4.085695904003281                   0   2.516254113637335  -5.985145774429562  -3.686066714086855
                   0                   0                   0                   0                   0                   0


Phi_tilde =

   2.036337655816100  -0.000000002024178   4.741070782231251  -0.000000001927914  -5.919228236757849 -13.781349074556333
   2.036337655816100  -0.000000002024178   4.741070782231251  -0.000000001927914  -5.919228236757849 -13.781349074556333
   2.036337655816100  -0.000000002024178   4.741070782231251  -0.000000001927914  -5.919228236757849 -13.781349074556333
   2.036337655816100  -0.000000002024178   4.741070782231251  -0.000000001927914  -5.919228236757849 -13.781349074556333


ans =

  23.481184064004317

Elapsed time is 0.839942 seconds.
#+end_example

[[file:./20220311_1816_581x464.png]]

- comments :: Here, I notice that it consistently estimates the values (2 line in this case). This was the method I used in the paper, so I could get consistently the zone which I was interested.

** Estimating $\Sigma$
*** All zones

@@latex:\footnotesize@@
#+begin_example
Converged after 8 iter

Phi_init =

   1.888984484329581   1.031449613340461   0.493603574506341   1.570339258366121  -4.024766135721050  -1.589286702732742
   2.022062300212486   0.168959767636359   0.590585082578745   0.595341413093424  -3.865332367880572   0.788009062310685
   0.035333013644131   0.706814664279490   0.963482900971306   2.084704975941461   0.119005470126404  -1.683090877030933
   0.841960316915978   0.434062545389897   0.257116624739541   0.903576841067326   0.124936414475057   0.090467251413719


Phi_init_orig =

   1.409026875600000   0.204403206500000   0.204403206500000   1.211227260900000  -4.440733954264350  -2.395604785023592
   1.374532382141822                   0                   0                   0  -4.036458625122800                   0
                   0                   0                   0   1.181575114762127                   0  -1.751401132713173
                   0                   0                   0                   0                   0                   0


Phi =

   1.409026874173281   0.204403191916454   0.204403211721927   1.211227193540284  -4.440733941807762  -2.395604755546574
   1.374532376483672   0.000000003094674  -0.000000004438757   0.000000011957244  -4.036458629983115  -0.000000043205520
   0.000000013718863   0.000000017020466   0.000000001595029   1.181575111449390  -0.000000073644437  -1.751401138619064
   0.000000000908986  -0.000000000384054   0.000000000130239   0.000000000420273  -0.000000003582068  -0.000000002293883


ans =

     1.177584432120745e-07

Converged after 4 iter

Phi_init_tilde =

   2.117550105402768   8.594438399200678  11.428322723470759  11.081756163462192 -16.585407110994204 -48.511155164968422
   0.589800370016224   0.361588787921513   9.939228633655992   0.946333327305658  -0.563376675908429 -27.722387651607008
   0.110581105160798   8.365100069594455   0.248879009508006   9.283416513250192 -11.542047713140736 -13.051888130207459
   0.536634437524078   0.903737539380667   0.909512801053707   0.267664357678808   0.568385972440423   0.851356923976614


Phi_init_orig_tilde =

   1.634455595021149   8.379446932027005  11.311498352607458  10.900108853809826 -17.220266618727628 -49.374193971149374
   0.220364386134201                   0   9.472027534173067                   0  -0.647123151580660 -27.815603134891198
                   0   8.142341472727709                   0   9.259184487049342 -12.069064336331813 -13.724515687589738
                   0                   0                   0                   0                   0                   0


Phi_tilde =

   1.634455630777189   8.379446465507055  11.311498383696431  10.900108225461915 -17.220266413601784 -49.374193654318951
   0.220364354639213   0.000000082894588   9.472027460398778   0.000000115026309  -0.647123450093029 -27.815603506955771
   0.000000013190887   8.142341452628051   0.000000107037060   9.259184578379301 -12.069064388836477 -13.724516241360613
   0.000000001043216   0.000000002834571   0.000000007284496   0.000000000646842  -0.000000016381632  -0.000000042659926


ans =

     1.158960644823133e-06

Elapsed time is 1.206811 seconds.
#+end_example

[[file:./20220311_1749_583x464.png]]

- comments :: Here, it converges consistently when the initial error is small (1*rand()).

*** One zone

@@latex:\footnotesize@@
#+begin_example
Converged after 2 iter

Phi_init =

   1.535576817100000   0.267670288000000   0.267670288000000   1.275741311900000  -4.993629485939564  -2.677930939757034
   1.479415444563356                   0                   0                   0  -4.431758094613904                   0
                   0                   0                   0   1.229083025398051                   0  -1.807478724158308
                   0                   0                   0                   0                   0                   0


Phi_init_orig =

   1.535576817100000   0.267670288000000   0.267670288000000   1.275741311900000  -4.993629485939564  -2.677930939757034
   1.479415444563356                   0                   0                   0  -4.431758094613904                   0
                   0                   0                   0   1.229083025398051                   0  -1.807478724158308
                   0                   0                   0                   0                   0                   0


Phi =

   1.479415445995298   0.000000000837191  -0.000000000062339  -0.000000000719291  -4.431758097893068   0.000000000460229
   1.479415446376144  -0.000000000592284  -0.000000002690963   0.000000000293795  -4.431758092749845  -0.000000002527891
   1.479415447000903   0.000000002127020  -0.000000000659512  -0.000000001855795  -4.431758102439962   0.000000004980285
   1.479415447526047  -0.000000000092541  -0.000000001004702   0.000000000777582  -4.431758094638814  -0.000000004910697


ans =

   7.595847721134342
#+end_example

#+begin_example
Max iterations reached

Phi_init_tilde =

  13.492683564741229  10.496427805263544  10.767428378719371   7.279081921846479 -52.203144780091222 -40.306523848462284
  10.892476417425700   0.516397454085014   9.188341234014356   0.834801726897620 -31.710202602728003 -25.787764467618974
   0.915718325374517   7.386311383931365   0.647929010283169   5.499766690325515 -10.203945719553941  -7.053524353226981
   0.477894569504026   0.425630276755258   0.742875829219295   0.671035339436976   0.872326734416339   0.767223387382563


Phi_init_orig_tilde =

  12.782199348420676   9.522398151104319  10.199366953104240   6.765020233161592 -52.294094697345699 -40.501949183871133
  10.784252717876383                   0   8.779960920513417                   0 -32.305461898781680 -26.301376684196658
                   0   7.294300577108211                   0   4.987142722018295 -10.726934493679865  -7.334048374372181
                   0                   0                   0                   0                   0                   0


Phi_tilde =

   NaN   NaN   NaN   NaN   NaN   NaN
   NaN   NaN   NaN   NaN   NaN   NaN
   NaN   NaN   NaN   NaN   NaN   NaN
   NaN   NaN   NaN   NaN   NaN   NaN


ans =

   NaN

Elapsed time is 12.522801 seconds.
#+end_example

[[file:./20220311_1741_584x464.png]]

- comments :: Here, even though is initialized close to the truth value sometimes it diverges (reason still unknown).
* References
\printbibliography
